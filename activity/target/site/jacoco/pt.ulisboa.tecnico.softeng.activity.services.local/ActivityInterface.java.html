<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ActivityInterface.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">activity</a> &gt; <a href="index.source.html" class="el_package">pt.ulisboa.tecnico.softeng.activity.services.local</a> &gt; <span class="el_source">ActivityInterface.java</span></div><h1>ActivityInterface.java</h1><pre class="source lang-java linenums">package pt.ulisboa.tecnico.softeng.activity.services.local;

import java.util.List;
import java.util.stream.Collectors;

import pt.ist.fenixframework.Atomic;
import pt.ist.fenixframework.Atomic.TxMode;
import pt.ist.fenixframework.FenixFramework;
import pt.ulisboa.tecnico.softeng.activity.domain.Activity;
import pt.ulisboa.tecnico.softeng.activity.domain.ActivityOffer;
import pt.ulisboa.tecnico.softeng.activity.domain.ActivityProvider;
import pt.ulisboa.tecnico.softeng.activity.domain.Booking;
import pt.ulisboa.tecnico.softeng.activity.exception.ActivityException;
import pt.ulisboa.tecnico.softeng.activity.services.local.dataobjects.ActivityData;
import pt.ulisboa.tecnico.softeng.activity.services.local.dataobjects.ActivityOfferData;
import pt.ulisboa.tecnico.softeng.activity.services.local.dataobjects.ActivityProviderData;
import pt.ulisboa.tecnico.softeng.activity.services.remote.dataobjects.RestActivityBookingData;

<span class="nc" id="L19">public class ActivityInterface {</span>

	@Atomic(mode = TxMode.READ)
	public static List&lt;ActivityProviderData&gt; getProviders() {
		return FenixFramework.getDomainRoot().getActivityProviderSet().stream()
<span class="nc" id="L24">				.sorted((p1, p2) -&gt; p1.getName().compareTo(p2.getName())).map(p -&gt; new ActivityProviderData(p))</span>
				.collect(Collectors.toList());
	}

	@Atomic(mode = TxMode.WRITE)
	public static void createProvider(ActivityProviderData provider) {
		new ActivityProvider(provider.getCode(), provider.getName(), provider.getNif(), provider.getIban());
	}

	@Atomic(mode = TxMode.READ)
	public static ActivityProviderData getProviderDataByCode(String code) {
		ActivityProvider provider = getProviderByCode(code);
		if (provider == null) {
			return null;
		}

		return new ActivityProviderData(provider);
	}

	@Atomic(mode = TxMode.WRITE)
	public static void createActivity(String code, ActivityData activity) {
		ActivityProvider provider = getProviderByCode(code);
		if (provider == null) {
			throw new ActivityException();
		}

		new Activity(provider, activity.getName(), activity.getMinAge() != null ? activity.getMinAge() : -1,
				activity.getMaxAge() != null ? activity.getMaxAge() : -1,
				activity.getCapacity() != null ? activity.getCapacity() : -1);
	}

	@Atomic(mode = TxMode.WRITE)
	public static ActivityData getActivityDataByCode(String codeProvider, String codeActivity) {
		Activity activity = getActivityByCode(codeProvider, codeActivity);
		if (activity == null) {
			return null;
		}

		return new ActivityData(activity);
	}

	@Atomic(mode = TxMode.READ)
	public static ActivityOfferData getActivityOfferDataByExternalId(String externalId) {
		ActivityOffer offer = FenixFramework.getDomainObject(externalId);

		if (offer == null) {
			return null;
		}

		return new ActivityOfferData(offer);
	}

	@Atomic(mode = TxMode.WRITE)
	public static void createOffer(String codeProvider, String codeActivity, ActivityOfferData offer) {
		Activity activity = getActivityByCode(codeProvider, codeActivity);
		if (activity == null) {
			throw new ActivityException();
		}

		new ActivityOffer(activity, offer.getBegin(), offer.getEnd(),
				offer.getAmount() != null ? offer.getAmount() : -1);
	}

	@Atomic(mode = TxMode.WRITE)
	public static String reserveActivity(RestActivityBookingData activityBookingData) {
		Booking booking = getBookingByAdventureId(activityBookingData.getAdventureId());
		if (booking != null) {
			return booking.getReference();
		}

		List&lt;ActivityOffer&gt; offers;
		for (ActivityProvider provider : FenixFramework.getDomainRoot().getActivityProviderSet()) {
			offers = provider.findOffer(activityBookingData.getBegin(), activityBookingData.getEnd(),
					activityBookingData.getAge());
			if (!offers.isEmpty()) {
				Booking newBooking = offers.get(0).book(provider, offers.get(0), activityBookingData.getAge(),
						activityBookingData.getNif(), activityBookingData.getIban(),
						activityBookingData.getAdventureId());
				return newBooking.getReference();
			}
		}
		throw new ActivityException();
	}

	@Atomic(mode = TxMode.WRITE)
	public static void reserveActivity(String externalId, RestActivityBookingData bookingData) {
		ActivityOffer offer = FenixFramework.getDomainObject(externalId);

		if (offer == null) {
			throw new ActivityException();
		}

		new Booking(offer.getActivity().getActivityProvider(), offer, bookingData.getNif(), bookingData.getIban());
	}

	@Atomic(mode = TxMode.WRITE)
	public static String cancelReservation(String reference) {
		Booking booking = getBookingByReference(reference);
		if (booking != null &amp;&amp; booking.getCancel() == null) {
			return booking.cancel();
		}
		throw new ActivityException();
	}

	@Atomic(mode = TxMode.READ)
	public static RestActivityBookingData getActivityReservationData(String reference) {
		for (ActivityProvider provider : FenixFramework.getDomainRoot().getActivityProviderSet()) {
			for (Activity activity : provider.getActivitySet()) {
				for (ActivityOffer offer : activity.getActivityOfferSet()) {
					Booking booking = offer.getBooking(reference);
					if (booking != null) {
						return new RestActivityBookingData(booking);
					}
				}
			}
		}
		throw new ActivityException();
	}

	@Atomic(mode = TxMode.WRITE)
	public static void deleteActivityProviders() {
<span class="nc" id="L145">		FenixFramework.getDomainRoot().getActivityProviderSet().stream().forEach(p -&gt; p.delete());</span>
	}

	private static Booking getBookingByReference(String reference) {
<span class="fc bfc" id="L149" title="All 2 branches covered.">		for (ActivityProvider provider : FenixFramework.getDomainRoot().getActivityProviderSet()) {</span>
<span class="fc" id="L150">			Booking booking = provider.getBooking(reference);</span>
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">			if (booking != null) {</span>
<span class="nc" id="L152">				return booking;</span>
			}
<span class="fc" id="L154">		}</span>
<span class="fc" id="L155">		return null;</span>
	}

	private static Booking getBookingByAdventureId(String adventureId) {
<span class="fc bfc" id="L159" title="All 2 branches covered.">		for (ActivityProvider provider : FenixFramework.getDomainRoot().getActivityProviderSet()) {</span>
<span class="fc" id="L160">			Booking booking = provider.getBookingByAdventureId(adventureId);</span>
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">			if (booking != null) {</span>
<span class="nc" id="L162">				return booking;</span>
			}
<span class="fc" id="L164">		}</span>
<span class="fc" id="L165">		return null;</span>
	}

	public static ActivityProvider getProviderByCode(String code) {
<span class="nc" id="L169">		return FenixFramework.getDomainRoot().getActivityProviderSet().stream().filter(p -&gt; p.getCode().equals(code))</span>
<span class="nc" id="L170">				.findFirst().orElse(null);</span>
	}

	private static Activity getActivityByCode(String codeProvider, String codeActivity) {
<span class="nc" id="L174">		ActivityProvider provider = getProviderByCode(codeProvider);</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">		if (provider == null) {</span>
<span class="nc" id="L176">			return null;</span>
		}

<span class="nc" id="L179">		return provider.getActivitySet().stream().filter(a -&gt; a.getCode().equals(codeActivity)).findFirst()</span>
<span class="nc" id="L180">				.orElse(null);</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>