<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BankInterface.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">bank</a> &gt; <a href="index.source.html" class="el_package">pt.ulisboa.tecnico.softeng.bank.services.local</a> &gt; <span class="el_source">BankInterface.java</span></div><h1>BankInterface.java</h1><pre class="source lang-java linenums">package pt.ulisboa.tecnico.softeng.bank.services.local;

import java.util.List;
import java.util.stream.Collectors;

import pt.ist.fenixframework.Atomic;
import pt.ist.fenixframework.Atomic.TxMode;
import pt.ist.fenixframework.FenixFramework;
import pt.ulisboa.tecnico.softeng.bank.domain.Account;
import pt.ulisboa.tecnico.softeng.bank.domain.Bank;
import pt.ulisboa.tecnico.softeng.bank.domain.Client;
import pt.ulisboa.tecnico.softeng.bank.domain.Operation;
import pt.ulisboa.tecnico.softeng.bank.exception.BankException;
import pt.ulisboa.tecnico.softeng.bank.services.local.dataobjects.AccountData;
import pt.ulisboa.tecnico.softeng.bank.services.local.dataobjects.BankData;
import pt.ulisboa.tecnico.softeng.bank.services.local.dataobjects.BankOperationData;
import pt.ulisboa.tecnico.softeng.bank.services.local.dataobjects.ClientData;

<span class="nc" id="L19">public class BankInterface {</span>

	@Atomic(mode = TxMode.READ)

	public static List&lt;BankData&gt; getBanks() {
		return FenixFramework.getDomainRoot().getBankSet().stream()
<span class="nc" id="L25">				.sorted((b1, b2) -&gt; b1.getName().compareTo(b2.getName())).map(b -&gt; new BankData(b))</span>
				.collect(Collectors.toList());
	}

	@Atomic(mode = TxMode.WRITE)
	public static void createBank(BankData bankData) {
		new Bank(bankData.getName(), bankData.getCode());
	}

	@Atomic(mode = TxMode.READ)
	public static BankData getBankDataByCode(String code) {
		Bank bank = getBankByCode(code);
		if (bank == null) {
			return null;
		}

		return new BankData(bank);
	}

	@Atomic(mode = TxMode.WRITE)
	public static void createClient(String code, ClientData client) {
		Bank bank = getBankByCode(code);
		if (bank == null) {
			throw new BankException();
		}

		new Client(bank, client.getName());
	}

	@Atomic(mode = TxMode.READ)
	public static ClientData getClientDataById(String code, String id) {
		Bank bank = getBankByCode(code);
		if (bank == null) {
			return null;
		}

		Client client = bank.getClientById(id);
		if (client == null) {
			return null;
		}

		return new ClientData(client);
	}

	@Atomic(mode = TxMode.WRITE)
	public static void createAccount(String code, String id) {
		Bank bank = getBankByCode(code);
		if (bank == null) {
			throw new BankException();
		}

		Client client = bank.getClientById(id);
		if (client == null) {
			throw new BankException();
		}

		new Account(bank, client);
	}

	@Atomic(mode = TxMode.READ)
	public static AccountData getAccountData(String iban) {
		Account account = getAccountByIban(iban);
		if (account == null) {
			throw new BankException();
		}

		return new AccountData(account);
	}

	@Atomic(mode = TxMode.WRITE)
	public static void deposit(String iban, double amount) {
		Account account = getAccountByIban(iban);
		if (account == null) {
			throw new BankException();
		}

		account.deposit(amount);
	}

	@Atomic(mode = TxMode.WRITE)
	public static void withdraw(String iban, double amount) {
		Account account = getAccountByIban(iban);
		if (account == null) {
			throw new BankException();
		}

		account.withdraw(amount);
	}

	@Atomic(mode = TxMode.WRITE)
	public static String processPayment(BankOperationData bankOperationData) {
		Operation operation = getOperationBySourceAndReference(bankOperationData.getTransactionSource(),
				bankOperationData.getTransactionReference());
		if (operation != null) {
			return operation.getReference();
		}

		for (Bank bank : FenixFramework.getDomainRoot().getBankSet()) {
			Account account = bank.getAccount(bankOperationData.getIban());
			if (account != null) {
				Operation newOperation = account.withdraw(bankOperationData.getValue());
				newOperation.setTransactionSource(bankOperationData.getTransactionSource());
				newOperation.setTransactionReference(bankOperationData.getTransactionReference());
				return newOperation.getReference();
			}
		}
		throw new BankException();
	}

	@Atomic(mode = TxMode.WRITE)
	public static String cancelPayment(String paymentConfirmation) {
		Operation operation = getOperationByReference(paymentConfirmation);

		if (operation == null) {
			throw new BankException();
		} else if (operation.getCancellation() != null) {
			return operation.getCancellation();
		} else {
			return operation.revert();
		}

	}

	@Atomic(mode = TxMode.READ)
	public static BankOperationData getOperationData(String reference) {
		Operation operation = getOperationByReference(reference);
		if (operation != null) {
			return new BankOperationData(operation);
		}
		throw new BankException();
	}

	@Atomic(mode = TxMode.WRITE)
	public static void deleteBanks() {
<span class="nc" id="L159">		FenixFramework.getDomainRoot().getBankSet().stream().forEach(b -&gt; b.delete());</span>
	}

	private static Operation getOperationByReference(String reference) {
<span class="fc bfc" id="L163" title="All 2 branches covered.">		for (Bank bank : FenixFramework.getDomainRoot().getBankSet()) {</span>
<span class="fc" id="L164">			Operation operation = bank.getOperation(reference);</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">			if (operation != null) {</span>
<span class="fc" id="L166">				return operation;</span>
			}
<span class="fc" id="L168">		}</span>
<span class="fc" id="L169">		return null;</span>
	}

	private static Operation getOperationBySourceAndReference(String transactionSource, String transactionReference) {
<span class="fc bfc" id="L173" title="All 2 branches covered.">		for (Bank bank : FenixFramework.getDomainRoot().getBankSet()) {</span>
<span class="fc" id="L174">			Operation operation = bank.getOperationBySourceAndReference(transactionSource, transactionReference);</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">			if (operation != null) {</span>
<span class="fc" id="L176">				return operation;</span>
			}
<span class="fc" id="L178">		}</span>
<span class="fc" id="L179">		return null;</span>
	}

	private static Bank getBankByCode(String code) {
<span class="nc" id="L183">		return FenixFramework.getDomainRoot().getBankSet().stream().filter(b -&gt; b.getCode().equals(code)).findFirst()</span>
<span class="nc" id="L184">				.orElse(null);</span>
	}

	private static Account getAccountByIban(String iban) {
<span class="nc bnc" id="L188" title="All 2 branches missed.">		Account account = FenixFramework.getDomainRoot().getBankSet().stream().filter(b -&gt; b.getAccount(iban) != null)</span>
<span class="nc" id="L189">				.map(b -&gt; b.getAccount(iban)).findFirst().orElse(null);</span>
<span class="nc" id="L190">		return account;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>