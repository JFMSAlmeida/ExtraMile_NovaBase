<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TaxInterface.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">tax</a> &gt; <a href="index.source.html" class="el_package">pt.ulisboa.tecnico.softeng.tax.services.local</a> &gt; <span class="el_source">TaxInterface.java</span></div><h1>TaxInterface.java</h1><pre class="source lang-java linenums">package pt.ulisboa.tecnico.softeng.tax.services.local;

import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

import pt.ist.fenixframework.Atomic;
import pt.ist.fenixframework.Atomic.TxMode;
import pt.ist.fenixframework.FenixFramework;
import pt.ulisboa.tecnico.softeng.tax.domain.Buyer;
import pt.ulisboa.tecnico.softeng.tax.domain.IRS;
import pt.ulisboa.tecnico.softeng.tax.domain.Invoice;
import pt.ulisboa.tecnico.softeng.tax.domain.ItemType;
import pt.ulisboa.tecnico.softeng.tax.domain.Seller;
import pt.ulisboa.tecnico.softeng.tax.domain.TaxPayer;
import pt.ulisboa.tecnico.softeng.tax.exception.TaxException;
import pt.ulisboa.tecnico.softeng.tax.services.local.dataobjects.InvoiceData;
import pt.ulisboa.tecnico.softeng.tax.services.local.dataobjects.ItemTypeData;
import pt.ulisboa.tecnico.softeng.tax.services.local.dataobjects.TaxPayerData;
import pt.ulisboa.tecnico.softeng.tax.services.local.dataobjects.TaxPayerData.Type;
import pt.ulisboa.tecnico.softeng.tax.services.remote.dataobjects.RestInvoiceData;

<span class="nc" id="L23">public class TaxInterface {</span>

	@Atomic(mode = TxMode.READ)
	public static List&lt;ItemTypeData&gt; getItemTypeDataList() {
<span class="nc" id="L27">		return IRS.getIRSInstance().getItemTypeSet().stream().map(i -&gt; new ItemTypeData(i))</span>
<span class="nc" id="L28">				.sorted((i1, i2) -&gt; i1.getName().compareTo(i2.getName())).collect(Collectors.toList());</span>
	}

	@Atomic(mode = TxMode.WRITE)
	public static void createItemType(ItemTypeData itemTypeData) {
		new ItemType(IRS.getIRSInstance(), itemTypeData.getName(),
				itemTypeData.getTax() != null ? itemTypeData.getTax() : -1);
	}

	@Atomic(mode = TxMode.READ)
	public static List&lt;TaxPayerData&gt; getTaxPayerDataList() {
<span class="nc" id="L39">		return IRS.getIRSInstance().getTaxPayerSet().stream().map(i -&gt; new TaxPayerData(i))</span>
<span class="nc" id="L40">				.sorted((i1, i2) -&gt; i1.getNif().compareTo(i2.getNif())).collect(Collectors.toList());</span>
	}

	@Atomic(mode = TxMode.WRITE)
	public static void createTaxPayer(TaxPayerData taxPayerData) {
		if (taxPayerData.getType().equals(Type.BUYER)) {
			new Buyer(IRS.getIRSInstance(), taxPayerData.getNif(), taxPayerData.getName(), taxPayerData.getAddress());
		} else {
			new Seller(IRS.getIRSInstance(), taxPayerData.getNif(), taxPayerData.getName(), taxPayerData.getAddress());
		}
	}

	@Atomic(mode = TxMode.WRITE)
	public static TaxPayerData getTaxPayerDataByNif(String nif) {
		TaxPayer taxPayer = IRS.getIRSInstance().getTaxPayerByNIF(nif);
		return new TaxPayerData(taxPayer);
	}

	@Atomic(mode = TxMode.READ)
	public static List&lt;InvoiceData&gt; getInvoiceDataList(String nif) {
		TaxPayer taxPayer = IRS.getIRSInstance().getTaxPayerByNIF(nif);
		if (taxPayer == null) {
			throw new TaxException();
		}

		if (taxPayer instanceof Buyer) {
<span class="nc" id="L66">			return ((Buyer) taxPayer).getInvoiceSet().stream().map(i -&gt; new InvoiceData(i))</span>
<span class="nc" id="L67">					.sorted((i1, i2) -&gt; i1.getSellerNif().compareTo(i2.getSellerNif())).collect(Collectors.toList());</span>
		} else {
<span class="nc" id="L69">			return ((Seller) taxPayer).getInvoiceSet().stream().map(i -&gt; new InvoiceData(i))</span>
<span class="nc" id="L70">					.sorted((i1, i2) -&gt; i1.getBuyerNif().compareTo(i2.getBuyerNif())).collect(Collectors.toList());</span>
		}
	}

	@Atomic(mode = TxMode.WRITE)
	public static void createInvoice(String nif, InvoiceData invoiceData) {
		if (invoiceData.getValue() == null || invoiceData.getItemType() == null || invoiceData.getDate() == null
				|| invoiceData.getBuyerNif() == null &amp;&amp; invoiceData.getSellerNif() == null
						&amp;&amp; invoiceData.getTime() == null) {
			throw new TaxException();
		}

		TaxPayer taxPayer = IRS.getIRSInstance().getTaxPayerByNIF(nif);
		ItemType itemType = IRS.getIRSInstance().getItemTypeByName(invoiceData.getItemType());

		Seller seller;
		Buyer buyer;
		if (invoiceData.getSellerNif() != null) {
			seller = (Seller) IRS.getIRSInstance().getTaxPayerByNIF(invoiceData.getSellerNif());
			buyer = (Buyer) taxPayer;
		} else {
			seller = (Seller) taxPayer;
			buyer = (Buyer) IRS.getIRSInstance().getTaxPayerByNIF(invoiceData.getBuyerNif());
		}

		new Invoice(invoiceData.getValue(), invoiceData.getDate(), itemType, seller, buyer);
	}

	@Atomic(mode = TxMode.WRITE)
	public static String submitInvoice(RestInvoiceData invoiceData) {
		Invoice invoice = getInvoiceByInvoiceData(invoiceData);
		if (invoice != null) {
			return invoice.getReference();
		}

		Seller seller = (Seller) IRS.getIRSInstance().getTaxPayerByNIF(invoiceData.getSellerNif());
		Buyer buyer = (Buyer) IRS.getIRSInstance().getTaxPayerByNIF(invoiceData.getBuyerNif());
		ItemType itemType = IRS.getIRSInstance().getItemTypeByName(invoiceData.getItemType());

		invoice = new Invoice(invoiceData.getValue(), invoiceData.getDate(), itemType, seller, buyer,
				invoiceData.getTime());

		return invoice.getReference();
	}

	@Atomic(mode = TxMode.WRITE)
	public static void cancelInvoice(String reference) {
		Invoice invoice = getInvoiceByReference(reference);

		if (invoice != null &amp;&amp; invoice.getCancelled()) {
			return;
		}

<span class="nc" id="L123">		invoice = IRS.getIRSInstance().getInvoiceSet().stream().filter(i -&gt; i.getReference().equals(reference))</span>
<span class="nc" id="L124">				.findFirst().orElseThrow(() -&gt; new TaxException());</span>
		invoice.cancel();
	}

	@Atomic(mode = TxMode.WRITE)
	public static void deleteIRS() {
		FenixFramework.getDomainRoot().getIrs().delete();
	}

	private static Invoice getInvoiceByReference(String reference) {
<span class="nc" id="L134">		return IRS.getIRSInstance().getInvoiceSet().stream().filter(i -&gt; i.getReference().equals(reference)).findFirst()</span>
<span class="nc" id="L135">				.orElse(null);</span>
	}

	private static Invoice getInvoiceByInvoiceData(RestInvoiceData invoiceData) {
<span class="fc" id="L139">		Optional&lt;Invoice&gt; inOptional = IRS.getIRSInstance().getInvoiceSet().stream()</span>
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">				.filter(i -&gt; i.getBuyer().getNif().equals(invoiceData.getBuyerNif())</span>
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">						&amp;&amp; i.getSeller().getNif().equals(invoiceData.getSellerNif())</span>
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">						&amp;&amp; i.getItemType().getName().equals(invoiceData.getItemType())</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">						&amp;&amp; i.getValue() == invoiceData.getValue().doubleValue()</span>
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">						&amp;&amp; i.getTime().getMillis() == invoiceData.getTime().getMillis())</span>
<span class="fc" id="L145">				.findFirst();</span>

<span class="fc" id="L147">		return inOptional.orElse(null);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>