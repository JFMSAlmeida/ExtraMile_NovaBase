<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RentACarInterface.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">car</a> &gt; <a href="index.source.html" class="el_package">pt.ulisboa.tecnico.softeng.car.services.local</a> &gt; <span class="el_source">RentACarInterface.java</span></div><h1>RentACarInterface.java</h1><pre class="source lang-java linenums">package pt.ulisboa.tecnico.softeng.car.services.local;

import java.util.List;
import java.util.stream.Collectors;

import org.joda.time.LocalDate;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import pt.ist.fenixframework.Atomic;
import pt.ist.fenixframework.FenixFramework;
import pt.ulisboa.tecnico.softeng.car.domain.Car;
import pt.ulisboa.tecnico.softeng.car.domain.Motorcycle;
import pt.ulisboa.tecnico.softeng.car.domain.RentACar;
import pt.ulisboa.tecnico.softeng.car.domain.Renting;
import pt.ulisboa.tecnico.softeng.car.domain.Vehicle;
import pt.ulisboa.tecnico.softeng.car.exception.CarException;
import pt.ulisboa.tecnico.softeng.car.services.local.dataobjects.RentACarData;
import pt.ulisboa.tecnico.softeng.car.services.local.dataobjects.RentingData;
import pt.ulisboa.tecnico.softeng.car.services.local.dataobjects.VehicleData;
import pt.ulisboa.tecnico.softeng.car.services.remote.dataobjects.RestRentingData;

<span class="nc" id="L23">public class RentACarInterface {</span>
<span class="nc" id="L24">	private static Logger logger = LoggerFactory.getLogger(RentACarInterface.class);</span>

	@Atomic(mode = Atomic.TxMode.READ)
	public static List&lt;RentACarData&gt; getRentACars() {
		return FenixFramework.getDomainRoot().getRentACarSet().stream()
<span class="nc" id="L29">				.map(r -&gt; new RentACarData(r.getCode(), r.getName(), r.getNif(), r.getIban(), r.getVehicleSet().size()))</span>
				.collect(Collectors.toList());
	}

	@Atomic(mode = Atomic.TxMode.WRITE)
	public static void createRentACar(RentACarData rentACarData) {
		new RentACar(rentACarData.getName(), rentACarData.getNif(), rentACarData.getIban());
	}

	@Atomic(mode = Atomic.TxMode.READ)
	public static List&lt;VehicleData&gt; getVehicles(String code) {
		RentACar rentACar = getRentACar(code);
<span class="nc" id="L41">		return rentACar.getVehicleSet().stream().map(v -&gt; new VehicleData(getVehicleType(v), v.getPlate(),</span>
<span class="nc" id="L42">				v.getKilometers(), v.getPrice(), toRentACarData(v.getRentACar()))).collect(Collectors.toList());</span>
	}

	@Atomic(mode = Atomic.TxMode.READ)
	public static List&lt;RentingData&gt; getRentings(String code, String plate) {
		Vehicle vehicle = getVehicle(code, plate);
		return vehicle.getRentingSet().stream().map(RentingData::new).collect(Collectors.toList());
	}

	@Atomic(mode = Atomic.TxMode.READ)
	public static RentingData getRentingData(String code, String plate, String reference) {
		Renting renting = getVehicle(code, plate).getRentingSet().stream()
<span class="nc" id="L54">				.filter(r -&gt; r.getReference().equals(reference)).findFirst().orElse(null);</span>

		return renting == null ? new RentingData() : new RentingData(renting);
	}

	@Atomic(mode = Atomic.TxMode.READ)
	public static RestRentingData getRentingData(String reference) {
		Renting renting = FenixFramework.getDomainRoot().getRentACarSet().stream()
<span class="nc" id="L62">				.flatMap(rac -&gt; rac.getVehicleSet().stream()).flatMap(v -&gt; v.getRentingSet().stream())</span>
<span class="nc" id="L63">				.filter(r -&gt; r.getReference().equals(reference)).findFirst().orElseThrow(() -&gt; new CarException());</span>

		return new RestRentingData(renting);
	}

	@Atomic(mode = Atomic.TxMode.WRITE)
	public static RentingData cancelRenting(String code, String plate, String reference) {
		Renting renting = getVehicle(code, plate).getRentingSet().stream()
<span class="nc" id="L71">				.filter(r -&gt; r.getReference().equals(reference)).findFirst().orElse(null);</span>

		if (renting == null) {
			return new RentingData();
		} else {
			renting.cancel();
			return new RentingData(renting);
		}
	}

	@Atomic(mode = Atomic.TxMode.WRITE)
	public static String cancelRenting(String reference) {
		Renting renting = getRenting(reference);
		if (renting.getCancellationReference() != null) {
			return renting.getCancellationReference();
		}

		renting.cancel();
		return renting.getCancellationReference();
	}

	@Atomic(mode = Atomic.TxMode.WRITE)
	public static RentingData checkoutRenting(String code, String plate, String reference, Integer kms) {
		if (kms == null) {
			throw new CarException();
		}

		Renting renting = getVehicle(code, plate).getRentingSet().stream()
<span class="nc" id="L99">				.filter(r -&gt; r.getReference().equals(reference)).findFirst().orElse(null);</span>

		if (renting == null) {
			return new RentingData();
		} else {
			renting.checkout(kms);
			return new RentingData(renting);
		}
	}

	@Atomic(mode = Atomic.TxMode.READ)
	public static RentACarData getRentACarData(String code) {
		return toRentACarData(getRentACar(code));
	}

	@Atomic(mode = Atomic.TxMode.WRITE)
	public static void createVehicle(String code, VehicleData vehicleData) {
		if (vehicleData.getKilometers() == null || vehicleData.getPrice() == null) {
			throw new CarException();
		}

		RentACar rentACar = getRentACar(code);
		if (vehicleData.getType() == Vehicle.Type.CAR) {
			new Car(vehicleData.getPlate(), vehicleData.getKilometers(), vehicleData.getPrice(), rentACar);
		} else {
			new Motorcycle(vehicleData.getPlate(), vehicleData.getKilometers(), vehicleData.getPrice(), rentACar);
		}
	}

	@Atomic(mode = Atomic.TxMode.READ)
	public static VehicleData getVehicleByPlate(String code, String plate) {
<span class="nc" id="L130">		return getVehicles(code).stream().filter(v -&gt; v.getPlate().equals(plate)).findFirst().orElse(null);</span>
	}

	@Atomic(mode = Atomic.TxMode.WRITE)
	public static String rent(String code, String plate, String drivingLicense, String buyerNIF, String buyerIBAN,
			LocalDate begin, LocalDate end, String adventureId) {

		Renting renting = getReting4AdventureId(adventureId);
		if (renting != null) {
			return renting.getReference();
		}

		return getVehicle(code, plate).rent(drivingLicense, begin, end, buyerNIF, buyerIBAN, adventureId)
				.getReference();
	}

	@Atomic(mode = Atomic.TxMode.WRITE)
	public static String rent(String type, String license, String nif, String iban, LocalDate begin, LocalDate end,
			String adventureId) {
		Renting renting = getReting4AdventureId(adventureId);
		if (renting != null) {
			return renting.getReference();
		}

		return RentACar.rent(type.equals(&quot;CAR&quot;) ? Car.class : Motorcycle.class, license, nif, iban, begin, end,
				adventureId);

	}

	@Atomic(mode = Atomic.TxMode.READ)
	public static VehicleData getVehicleData(String code, String plate) {
		Vehicle v = getVehicle(code, plate);
		return new VehicleData(getVehicleType(v), v.getPlate(), v.getKilometers(), v.getPrice(), getRentACarData(code));
	}

	private static Vehicle getVehicle(String code, String plate) {
<span class="nc" id="L166">		return getRentACar(code).getVehicleSet().stream().filter(v -&gt; v.getPlate().equals(plate)).findFirst()</span>
<span class="nc" id="L167">				.orElse(null);</span>
	}

	private static RentACarData toRentACarData(RentACar rentACar) {
<span class="nc" id="L171">		return new RentACarData(rentACar.getCode(), rentACar.getName(), rentACar.getNif(), rentACar.getIban(),</span>
<span class="nc" id="L172">				rentACar.getVehicleSet().size());</span>
	}

	private static RentACar getRentACar(String code) {
<span class="nc" id="L176">		return FenixFramework.getDomainRoot().getRentACarSet().stream().filter(h -&gt; h.getCode().equals(code))</span>
<span class="nc" id="L177">				.findFirst().orElse(null);</span>
	}

	private static Vehicle.Type getVehicleType(Vehicle vehicle) {
<span class="nc bnc" id="L181" title="All 2 branches missed.">		if (vehicle instanceof Car) {</span>
<span class="nc" id="L182">			return Vehicle.Type.CAR;</span>
		} else {
<span class="nc" id="L184">			return Vehicle.Type.MOTORCYCLE;</span>
		}
	}

	@Atomic(mode = Atomic.TxMode.WRITE)
	public static void deleteRentACars() {
		for (RentACar rentACar : FenixFramework.getDomainRoot().getRentACarSet()) {
			rentACar.delete();
		}
	}

	public static Renting getRenting(String reference) {
<span class="nc" id="L196">		Renting renting = FenixFramework.getDomainRoot().getRentACarSet().stream()</span>
<span class="nc" id="L197">				.flatMap(rac -&gt; rac.getVehicleSet().stream()).flatMap(v -&gt; v.getRentingSet().stream())</span>
<span class="nc" id="L198">				.filter(r -&gt; r.getReference().equals(reference)).findFirst().orElseThrow(() -&gt; new CarException());</span>

<span class="nc" id="L200">		return renting;</span>
	}

	private static Renting getReting4AdventureId(String adventureId) {
<span class="nc bnc" id="L204" title="All 2 branches missed.">		for (RentACar rentACar : FenixFramework.getDomainRoot().getRentACarSet()) {</span>
<span class="nc" id="L205">			Renting renting = rentACar.getRenting4AdventureId(adventureId);</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">			if (renting != null) {</span>
<span class="nc" id="L207">				return renting;</span>
			}
<span class="nc" id="L209">		}</span>
<span class="nc" id="L210">		return null;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>